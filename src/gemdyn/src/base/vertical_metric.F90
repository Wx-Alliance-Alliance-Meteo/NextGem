!---------------------------------- LICENCE BEGIN -------------------------------
! GEM - Library of kernel routines for the GEM numerical atmospheric model
! Copyright (C) 1990-2010 - Division de Recherche en Prevision Numerique
!                       Environnement Canada
! This library is free software; you can redistribute it and/or modify it
! under the terms of the GNU Lesser General Public License as published by
! the Free Software Foundation, version 2.1 of the License. This library is
! distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
! without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
! PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
! You should have received a copy of the GNU Lesser General Public License
! along with this library; if not, write to the Free Software Foundation, Inc.,
! 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
!---------------------------------- LICENCE END ---------------------------------

!**s/r vertical_metric - Compute vertical metric coefficients

      subroutine vertical_metric (F_metric, F_topo, F_orols, Minx,Maxx,Miny,Maxy)
      use, intrinsic :: iso_fortran_env
      use gem_options
      use lam_options
      use dyn_fisl_options
      use dynkernel_options
      use HORgrid_options
      use geomh
      use tdpack
      use glb_ld
      use mem_nest
      use mem_tstp
      use gmm_geof
      use cstv
      use ver
      use lun
      use sol_mem
      implicit none

      integer, intent(IN) :: Minx,Maxx,Miny,Maxy
      real, dimension (Minx:Maxx,Miny:Maxy), intent(IN) :: F_topo, F_orols
      type(Vmetric) , intent(INOUT) :: F_metric

      integer :: i,j,k, k0, err
      real, parameter :: one=1.d0, half=.5d0
      real(kind=REAL64) :: zthtu_8(l_minx:l_maxx,l_miny:l_maxy,0:G_nk+1),&
                           zthtv_8(l_minx:l_maxx,l_miny:l_maxy,0:G_nk+1)
!
!     ---------------------------------------------------------------
!
      k0= 1+Lam_gbpil_T

      do k=1,G_nk
         do j=1-G_haloy,l_nj+G_haloy
            do i=1-G_halox,l_ni+G_halox
               F_metric%zmom_8(i,j,k)=ver_z_8%m(k)+(Ver_b_8%m(k)*F_topo(i,j)+Ver_c_8%m(k)*F_orols(i,j))/grav_8
               F_metric%ztht_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*F_topo(i,j)+Ver_c_8%t(k)*F_orols(i,j))/grav_8
               zthtu_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*fis0u(i,j)+Ver_c_8%t(k)*orolsu(i,j))/grav_8
               zthtv_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*fis0v(i,j)+Ver_c_8%t(k)*orolsv(i,j))/grav_8
            end do
         end do
      end do
      do j=1-G_haloy,l_nj+G_haloy
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,0)=ver_z_8%m(0)
            zthtu_8(i,j,0)=ver_z_8%m(0)
            zthtv_8(i,j,0)=ver_z_8%m(0)
            F_metric%zmom_8(i,j,0)=ver_z_8%m(0)
            F_metric%zmom_8(i,j,G_nk+1)= F_topo(i,j)/grav_8
            F_metric%ztht_8(i,j,G_nk+1)= F_metric%zmom_8(i,j,G_nk+1)
            zthtu_8(i,j,G_nk+1)= fis0u(i,j)/grav_8
            zthtv_8(i,j,G_nk+1)= fis0v(i,j)/grav_8
            F_metric%lg_pstar_8(i,j,G_nk+1)=log(1.d5)-grav_8*F_metric%zmom_8(i,j,G_nk+1)/(rgasd_8*Cstv_Tstr_8)
            F_metric%zthtlid_8(i,j)= half*(ver_z_8%m(0)+F_metric%zmom_8(i,j,1))
         end do
      end do

      do k=1,G_nk
         do j=1-G_haloy,l_nj+G_haloy
            do i=1-G_halox,l_ni+G_halox
               dgzm(i,j,k)=F_metric%zmom_8(i,j,k)-F_metric%zmom_8(i,j,k+1)
               dgzt(i,j,k)=F_metric%ztht_8(i,j,k)-F_metric%ztht_8(i,j,k+1)
            end do
         end do
      end do

      if (Lun_debug_L) then
         call glbstat ( dgzm,'DGZM',"metric",l_minx,l_maxx,l_miny,l_maxy,1,l_nk,&
                        1-G_halox,G_ni+G_halox,1-G_haloy,G_nj+G_haloy,1,l_nk )
         call glbstat ( dgzt,'DGZT',"metric",l_minx,l_maxx,l_miny,l_maxy,1,l_nk,&
                        1-G_halox,G_ni+G_halox,1-G_haloy,G_nj+G_haloy,1,l_nk )
      endif

      err=0
      if (minval(dgzm)<0. .or. minval(dgzt)<0. ) err=-1
!      call gem_error (err,'vertical_metric','Heights NOT monotonically decreasing from model top')

      do j=1-G_haloy,l_nj+G_haloy
         do k=G_nk,1,-1
            do i=1-G_halox,l_ni+G_halox
               F_metric%lg_pstar_8(i,j,k)=F_metric%lg_pstar_8(i,j,k+1)+grav_8*(F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))/(rgasd_8*Cstv_Tstr_8)
            end do
         end do
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,G_nk)= F_metric%zmom_8(i,j,G_nk+1) !temporary for mc_Ix_8 and mc_Iy_8 below
         end do
      end do
      do k=1,G_nk
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_Jx_8 (i,j,k)=(F_metric%zmom_8(i+1,j,k)-F_metric%zmom_8(i,j,k))*geomh_invDX_8(j)
               F_metric%mc_Jy_8 (i,j,k)=(F_metric%zmom_8(i,j+1,k)-F_metric%zmom_8(i,j,k))*geomh_invDY_8
               F_metric%mc_iJz_8(i,j,k)=one/(F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))
               
               F_metric%mc_Ix_8(i,j,k)=log( (zthtu_8(i,j,k)-zthtu_8(i,j,k-1))/(zthtu_8(i-1,j,k)-zthtu_8(i-1,j,k-1)) )*geomh_invDX_8(j)
               F_metric%mc_Iy_8(i,j,k)=log( (zthtv_8(i,j,k)-zthtv_8(i,j,k-1))/(zthtv_8(i,j-1,k)-zthtv_8(i,j-1,k-1)) )*geomh_invDY_8
               F_metric%mc_Iz_8(i,j,k)=log( (F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))/(Ver_z_8%m(k+1)-Ver_z_8%m(k)) &
                                  /(F_metric%zmom_8(i,j,k)-F_metric%zmom_8(i,j,k-1))*(Ver_z_8%m(k)-Ver_z_8%m(k-1)) )*Ver_idz_8%m(k)
               F_metric%mc_logJz_8(i,j,k)= 0.0

            end do
         end do
      end do
      do j=1-G_haloy+1,l_nj+G_haloy-1
!DIR$ SIMD
         do i=1-G_halox+1,l_ni+G_halox-1
            F_metric%mc_iJz_8(i,j,0)=one/(F_metric%zmom_8(i,j,1)-ver_z_8%m(0))
            F_metric%mc_css_H_8(i,j) = one/(gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk)-half*mu_8))
         end do
      end do

      do j=1-G_haloy,l_nj+G_haloy
!DIR$ SIMD
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,G_nk)= ver_z_8%t(G_nk)+(Ver_b_8%t(G_nk)*F_topo(i,j)+Ver_c_8%t(G_nk)*F_orols(i,j))/grav_8
         end do
      end do

      if (Schm_opentop_L) then
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_cst_8(i,j)= one / (-(mu_8* Cstv_tau_nh_8)*(isol_d*Ver_idz_8%t(k0-1) &
                              +isol_i*F_metric%mc_iJz_8(i,j,k0-1)) &
                              + half* one/(Cstv_tau_8*cpd_8*Cstv_Tstr_8))
            end do
         end do
      endif
      do j=1-G_haloy+1,l_nj+G_haloy-1
         do i=1-G_halox+1,l_ni+G_halox-1
            F_metric%mc_alfas_H_8(i,j) = F_metric%mc_css_H_8(i,j)*(gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk) &
                                + half*mu_8) + Ver_wmstar_8(G_nk)*gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk-1) &
                                               + isol_d*Ver_idz_8%t(G_nk-1)-half*mu_8) )

            F_metric%mc_betas_H_8(i,j) = F_metric%mc_css_H_8(i,j)* Ver_wmstar_8(G_nk)*gama_8* &
                                (isol_i*F_metric%mc_iJz_8(i,j,G_nk-1)+isol_d*Ver_idz_8%t(G_nk-1)+half*mu_8)

            F_metric%mc_cssp_H_8(i,j) = gama_8*(Ver_idz_8%m(G_nk)-epsi_8*Ver_wp_8%m(G_nk))*&
                               (isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk)-half*mu_8)*F_metric%mc_css_H_8(i,j)
         enddo
      enddo
      if (Schm_opentop_L) then
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_alfat_8(i,j)  = (-(mu_8* Cstv_tau_nh_8)*(isol_d*Ver_idz_8%t(k0-1)+isol_i*F_metric%mc_iJz_8(i,j,k0-1))  &
                                 - half* one/(Cstv_tau_8*cpd_8*Cstv_Tstr_8))*F_metric%mc_cst_8(i,j)
               F_metric%mc_cstp_8(i,j)   = F_metric%mc_cst_8(i,j) * gama_8 * &
                                 ((isol_d*Ver_idz_8%t(k0-1)+isol_i*F_metric%mc_iJz_8(i,j,k0-1))*&
                                 (Ver_idz_8%m(k0)+Ver_wm_8%m(k0)*epsi_8) + &
                                  mu_8*half*(Ver_idz_8%m(k0)+Ver_wm_8%m(k0)*epsi_8) )
            end do
         end do
      endif

!      call heights_uv ()
!
!     ---------------------------------------------------------------
!
      return
      end subroutine vertical_metric

      subroutine vertical_metric_omp (F_metric, F_topo, F_orols, Minx,Maxx,Miny,Maxy)
      use, intrinsic :: iso_fortran_env
      use gem_options
      use lam_options
      use dyn_fisl_options
      use dynkernel_options
      use HORgrid_options
      use geomh
      use tdpack
      use glb_ld
      use mem_nest
      use gmm_geof
      use mem_tstp
      use cstv
      use lun
      use ver
      use sol_mem
      implicit none

      integer, intent(IN) :: Minx,Maxx,Miny,Maxy
      real, dimension (Minx:Maxx,Miny:Maxy), intent(IN) :: F_topo, F_orols
      type(Vmetric) , intent(INOUT) :: F_metric

      integer :: i,j,k, k0, err
      real, parameter :: one=1.d0, half=.5d0
      real(kind=REAL64) :: zthtu_8(l_minx:l_maxx,l_miny:l_maxy,0:G_nk+1),&
                           zthtv_8(l_minx:l_maxx,l_miny:l_maxy,0:G_nk+1)
!
!     ---------------------------------------------------------------
!
      k0= 1+Lam_gbpil_T

!!$omp do collapse(2)
      do k=1,G_nk
         do j=1-G_haloy,l_nj+G_haloy
            do i=1-G_halox,l_ni+G_halox
               F_metric%zmom_8(i,j,k)=ver_z_8%m(k)+(Ver_b_8%m(k)*F_topo(i,j)+Ver_c_8%m(k)*F_orols(i,j))/grav_8
               F_metric%ztht_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*F_topo(i,j)+Ver_c_8%t(k)*F_orols(i,j))/grav_8
               zthtu_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*fis0u(i,j)+Ver_c_8%t(k)*orolsu(i,j))/grav_8
               zthtv_8(i,j,k)=ver_z_8%t(k)+(Ver_b_8%t(k)*fis0v(i,j)+Ver_c_8%t(k)*orolsv(i,j))/grav_8
            end do
         end do
      end do
!!$omp enddo
!!$omp do
      do j=1-G_haloy,l_nj+G_haloy
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,0)=ver_z_8%m(0)
            zthtu_8(i,j,0)=ver_z_8%m(0)
            zthtv_8(i,j,0)=ver_z_8%m(0)
            F_metric%zmom_8(i,j,0)=ver_z_8%m(0)
            F_metric%zmom_8(i,j,G_nk+1)= F_topo(i,j)/grav_8
            F_metric%ztht_8(i,j,G_nk+1)= F_metric%zmom_8(i,j,G_nk+1)
            zthtu_8(i,j,G_nk+1)= fis0u(i,j)/grav_8
            zthtv_8(i,j,G_nk+1)= fis0v(i,j)/grav_8
            F_metric%lg_pstar_8(i,j,G_nk+1)=log(1.d5)-grav_8*F_metric%zmom_8(i,j,G_nk+1)/(rgasd_8*Cstv_Tstr_8)
         end do
      end do
!!$omp enddo
!!$omp do collapse(2)
      do k=1,G_nk
         do j=1-G_haloy,l_nj+G_haloy
            do i=1-G_halox,l_ni+G_halox
               dgzm(i,j,k)=F_metric%zmom_8(i,j,k)-F_metric%zmom_8(i,j,k+1)
               dgzt(i,j,k)=F_metric%ztht_8(i,j,k)-F_metric%ztht_8(i,j,k+1)
            end do
         end do
      end do
!!$omp enddo

! Impossible code in an OMP parallel region
!!$!$omp single
!!$      err=0
!!$      if (minval(dgzm)<0. .or. minval(dgzt)<0. ) err=-1
!!$      call gem_error (err,'vertical_metric','Heights NOT monotonically decreasing from model top')
!!$      if (Lun_debug_L) then
!!$         call glbstat ( dgzm,'DGZM',"metric",l_minx,l_maxx,l_miny,l_maxy,1,l_nk,&
!!$                        1-G_halox,G_ni+G_halox,1-G_haloy,G_nj+G_haloy,1,l_nk )
!!$         call glbstat ( dgzt,'DGZT',"metric",l_minx,l_maxx,l_miny,l_maxy,1,l_nk,&
!!$                        1-G_halox,G_ni+G_halox,1-G_haloy,G_nj+G_haloy,1,l_nk )
!!$      endif
!!$!$omp end single

!!$omp do
      do j=1-G_haloy,l_nj+G_haloy
         do k=G_nk,1,-1
            do i=1-G_halox,l_ni+G_halox
               F_metric%lg_pstar_8(i,j,k)=F_metric%lg_pstar_8(i,j,k+1)+grav_8*(F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))/(rgasd_8*Cstv_Tstr_8)
            end do
         end do
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,G_nk)= F_metric%zmom_8(i,j,G_nk+1) !temporary for mc_Ix_8 and mc_Iy_8 below
         end do
      end do
!!$omp enddo

!!$omp do collapse(2)
      do k=1,G_nk
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_Jx_8 (i,j,k)=(F_metric%zmom_8(i+1,j,k)-F_metric%zmom_8(i,j,k))*geomh_invDX_8(j)
               F_metric%mc_Jy_8 (i,j,k)=(F_metric%zmom_8(i,j+1,k)-F_metric%zmom_8(i,j,k))*geomh_invDY_8
               F_metric%mc_iJz_8(i,j,k)=one/(F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))

               F_metric%mc_Ix_8(i,j,k)=log( (zthtu_8(i,j,k)-zthtu_8(i,j,k-1))/(zthtu_8(i-1,j,k)-zthtu_8(i-1,j,k-1)) )*geomh_invDX_8(j)
               F_metric%mc_Iy_8(i,j,k)=log( (zthtv_8(i,j,k)-zthtv_8(i,j,k-1))/(zthtv_8(i,j-1,k)-zthtv_8(i,j-1,k-1)) )*geomh_invDY_8
               F_metric%mc_Iz_8(i,j,k)=log( (F_metric%zmom_8(i,j,k+1)-F_metric%zmom_8(i,j,k))/(Ver_z_8%m(k+1)-Ver_z_8%m(k)) &
                                  /(F_metric%zmom_8(i,j,k)-F_metric%zmom_8(i,j,k-1))*(Ver_z_8%m(k)-Ver_z_8%m(k-1)) )*Ver_idz_8%m(k)
               F_metric%mc_logJz_8(i,j,k)= 0.0

            end do
         end do
      end do
!!$omp enddo
!!$omp do
      do j=1-G_haloy+1,l_nj+G_haloy-1
!DIR$ SIMD
         do i=1-G_halox+1,l_ni+G_halox-1
            F_metric%mc_iJz_8(i,j,0)=one/(F_metric%zmom_8(i,j,1)-ver_z_8%m(0))
            F_metric%mc_css_H_8(i,j) = one/(gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk)-half*mu_8))
         end do
      end do
!!$omp enddo
!!$omp do
      do j=1-G_haloy,l_nj+G_haloy
!DIR$ SIMD
         do i=1-G_halox,l_ni+G_halox
            F_metric%ztht_8(i,j,G_nk)= ver_z_8%t(G_nk)+(Ver_b_8%t(G_nk)*F_topo(i,j)+Ver_c_8%t(G_nk)*F_orols(i,j))/grav_8
         end do
      end do
!!$omp enddo

      if (Schm_opentop_L) then
!!$omp do
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_cst_8(i,j)= one / (-(mu_8* Cstv_tau_nh_8)*(isol_d*Ver_idz_8%t(k0-1) &
                              +isol_i*F_metric%mc_iJz_8(i,j,k0-1)) &
                              + half* one/(Cstv_tau_8*cpd_8*Cstv_Tstr_8))
            end do
         end do
!!$omp enddo
      endif
!!$omp do
      do j=1-G_haloy+1,l_nj+G_haloy-1
         do i=1-G_halox+1,l_ni+G_halox-1
            F_metric%mc_alfas_H_8(i,j) = F_metric%mc_css_H_8(i,j)*(gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk) &
                                + half*mu_8) + Ver_wmstar_8(G_nk)*gama_8*(isol_i*F_metric%mc_iJz_8(i,j,G_nk-1) &
                                               + isol_d*Ver_idz_8%t(G_nk-1)-half*mu_8) )

            F_metric%mc_betas_H_8(i,j) = F_metric%mc_css_H_8(i,j)* Ver_wmstar_8(G_nk)*gama_8* &
                                (isol_i*F_metric%mc_iJz_8(i,j,G_nk-1)+isol_d*Ver_idz_8%t(G_nk-1)+half*mu_8)

            F_metric%mc_cssp_H_8(i,j) = gama_8*(Ver_idz_8%m(G_nk)-epsi_8*Ver_wp_8%m(G_nk))*&
                               (isol_i*F_metric%mc_iJz_8(i,j,G_nk)+isol_d*Ver_idz_8%t(G_nk)-half*mu_8)*F_metric%mc_css_H_8(i,j)
         enddo
      enddo
!!$omp enddo
      if (Schm_opentop_L) then
!!$omp do
         do j=1-G_haloy+1,l_nj+G_haloy-1
            do i=1-G_halox+1,l_ni+G_halox-1
               F_metric%mc_alfat_8(i,j)  = (-(mu_8* Cstv_tau_nh_8)*(isol_d*Ver_idz_8%t(k0-1)+isol_i*F_metric%mc_iJz_8(i,j,k0-1))  &
                                 - half* one/(Cstv_tau_8*cpd_8*Cstv_Tstr_8))*F_metric%mc_cst_8(i,j)
               F_metric%mc_cstp_8(i,j)   = F_metric%mc_cst_8(i,j) * gama_8 * &
                                 ((isol_d*Ver_idz_8%t(k0-1)+isol_i*F_metric%mc_iJz_8(i,j,k0-1))*&
                                 (Ver_idz_8%m(k0)+Ver_wm_8%m(k0)*epsi_8) + &
                                  mu_8*half*(Ver_idz_8%m(k0)+Ver_wm_8%m(k0)*epsi_8) )
            end do
         end do
!!$omp enddo
      endif

!      call heights_uv () !revisit that code
!
!     ---------------------------------------------------------------
!
      return
      end subroutine vertical_metric_omp
